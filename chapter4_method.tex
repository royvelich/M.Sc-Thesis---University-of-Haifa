\chapter{Method}
At its core, our method formulates the necessary and sufficient conditions for quadrangulating a triangle-mesh by parametrization (integer-grid maps \cite{bommes:hal-00862648}), as a smooth unconstrained optimization problem using periodic functions. Our main objective function is a weighted sum of smooth sub-objective functions, of which their weights are controllable by the user. We believe that this approach is more suitable for 3D design and modeling tools since the quadrangulation process is continuous with the user constantly in the loop. This approach is also easily extensible by introducing additional sub-objectives smooth terms into the main objective, which can represent custom requirements of which the parameterization has to fulfill. Moreover, since the weights are controllable, the quadrangulation process can be executed in any desired order (e.g. achieve a seamless parametrization before handling singular points). That's why we decided  to call our approach \emph{Smooth and Interactive Parametrization-Based Quadrangulation}: \emph{Smooth} because we're using a smooth objective, \emph{Interactive} because small changes are immediately reflected to the user, and \emph{Parametrization-Based} because we solve a global parametrization problem. This chapter is organized as following: In section \ref{integer-grid-maps} we describe in detail the notion of inter-grid maps. In section \ref{label:quad_distortion_cond} we briefly describe how to we cope with quad-distortion in order to maximize mesh quality.
\section{Integer Grid Maps}
\label{integer-grid-maps}
The necessary and sufficient conditions for a parametrization mapping to form a valid quad mesh on the mesh's 3D surface are:
\begin{enumerate}
\item Seamless Condition
\item Singular Points Condition
\item Consistent Orientation Condition
\end{enumerate}
\subsection{Seamless Condition}
\label{label:seamless_cond}
The transition function $g_{ij}$ between two half-edges $e_i$ and $e_j$ on the parameterization domain that corresponds to the same surface edge that is part of a cut seam, has to be an integer-grid automorphism given by:
\begin{equation}\label{transition_g_ij}
\begin{split}
e_j = R^{r_{ij}}_{90^\circ}e_i + \vec{t}_{ij}
\end{split}
\end{equation}
Where  $r_{ij} \in \{0,1,2,3\}$ and $\vec{t}_{ij} \in \mathbb{Z}^2$. Figures \ref{fig:translation_req}, \ref{fig:angle_req} and \ref{fig:length_req} visually demonstrate the 3 requirements encoded by the seamless condition.
\begin{figure}[ht]
\centering
\includegraphics[width=9cm]{figures/seamless/translation.png}
\caption[The Translation Requirement]{The transition function $g_{ij}$, described by equation \ref{transition_g_ij}, should impose an integer translation between the two half edges.}
\label{fig:translation_req}
\end{figure}
\begin{figure}[ht]
\centering
\includegraphics[width=9cm]{figures/seamless/angle.png}
\caption[The Angle Requirement]{The transition function $g_{ij}$, described by equation \ref{transition_g_ij}, should impose a $\frac{\pi}{2}k$ rotation between the two half edges.}
\label{fig:angle_req}
\end{figure}
\begin{figure}[ht]
\centering
\includegraphics[width=9cm]{figures/seamless/length.png}
\caption[The Length Requirement]{The transition function $g_{ij}$, described by equation \ref{transition_g_ij}, should implicitly match the length of the two half edges.}
\label{fig:length_req}
\end{figure}
\subsection{Singular Points Condition}
\label{label:singular_points_cond}
Before we define what the singular-points condition is, we first have to define how a singular vertex is characterized on the parametrization domain. A singular-vertex (valence $\neq 4$) on the mesh's surface, will be characterized on the parametrization domain by a non-zero angular defect. The angular defect is measured by $2\pi - \sum_{i=1}^k \theta_i$ and $\pi - \sum_{i=1}^k \theta_i$ for interior and boundary surface vertices, respectively, where $k$ is the number of twin-vertices on the the parametrization domain that correspond to the singular-vertex on the mesh's surface, and $\theta_i$ is the angle adjacent to twin-vertex $v_i$.
Having the right definitions, the singular-points condition require that all twin-vertices of singular points will be located on integer locations. Formally, given the set $V$ of all twin-vertices on the domain the that correspond to the a singular vertex on the mesh's surface, we require that:
\begin{equation}\label{eq:singular_points_cond}
\begin{split}
\forall u \in V: u \in \mathbb{Z}^2
\end{split}
\end{equation}
Figure \ref{fig:singular_points_req} demonstrate this condition visually.
\begin{figure}[ht]
\centering
\includegraphics[width=9cm]{figures/singular_points/singularity.png}
\caption[The Singular Points Requirement]{Domain vertices that correspond to the same singular point should be positioned at a integer locations (grid points). In this illustration, the angular defect is $\frac{\pi}{2}$.}
\label{fig:singular_points_req}
\end{figure}
\subsection{Consistent Orientation Condition}
\label{label:consistent_otrientation_cond}
All triangles on the parameterization domain should have the same orientation. In other words, the transition function should not allow triangle flips. Figure \ref{fig:orientation_req} demonstrate this condition visually.
\begin{figure}[ht]
\centering
\includegraphics[width=9cm]{figures/orientation/orientation.png}
\caption[The Orientation Requirement]{The left triangle follows the same counter clockwise orientation as its image on the mesh's surface. On the other hand, the vertices of the triangle on the right follows a clockwise orientation.}
\label{fig:orientation_req}
\end{figure}
\section{Quad Distortion}
\label{label:quad_distortion_cond}
The fulfilment of the integer-grid maps conditions do guarantee that the isolines of the 2D Cartesian grid forms a valid quad-mesh on the 3D mesh's surface, however, we do have to consider at what cost. There are many possible integer-grid maps that transform a given triangle-mesh into a quad-mesh. Amongst them, we would like to pick the one that satisfies our desired set of additional requirements. In order to meet this desiderata, we have to pay with shape distortion of the triangles that make up the parametrization domain. Ultimately, we would like to find a map that fits our needs and minimizes the triangles distortion, since a distorted triangle renders a distorted isoline on the input mesh surface, which eventually affects the quality of the extracted quads that correspond to that triangle. Therefore, in addition to the integer-grid maps conditions, we add an additional implicit core requirement, which demands to find a mapping that minimizes triangle distortion. Figure \ref{fig:distortion_req} demonstrate this requirement visually.
\begin{figure}[ht]
\centering
\includegraphics[width=9cm]{figures/distortion/distortion.png}
\caption[The Orientation Requirement]{The left triangle has a little shape distortion compared with its original version on the input-mesh's surface, in contrast with the right triangle, which clearly express a high shape distortion compared with its original version}
\label{fig:distortion_req}
\end{figure}
\section{Smooth Objective Functions}
In this section, we present our smooth objective function formulations for Conditions \ref{label:seamless_cond}, \ref{label:singular_points_cond}, \ref{label:consistent_otrientation_cond} and requirement \ref{label:quad_distortion_cond} presented in the previous sections. Please note, in the following sections and subsections below, we denote by $\mathrm{x}\left(v\right)$, $\mathrm{y}\left(v\right)$ the $x$ and $y$ domain coordinates of a given domain vertex $v$.
\subsection{The Seamless Condition's Objective Functions}
The seamless condition can be expressed by three smooth objective (penalty) functions $P_{angle}$, $P_{length}$ and $P_{translation}$, that penalize violations in angle, length and translation, respectively, for a given pair of half-edges. In the following three paragraphs, we define those tree penalty functions, and assume we're given two half-edges, in the parametrization domain, denoted by $e_i = \left(v_i^1,v_i^2\right)$ and $e_j = \left(v_j^1,v_j^2\right)$, where for for $k \in \left\{i,j\right\}$, $v_k^1$ and $v_k^2$ are the two domain vertices that constitutes half-edge $k$, and for $k \in \left\{1,2\right\}$, $v_i^k$ and $v_j^k$ are twin-vertices.
\paragraph{Angle Penalty}
We define $P_{angle}$ as follows:
\begin{equation}\label{eq:angle_penalty}
\begin{split}
P_{angle}\left(e_i,e_j\right) = \mathrm{sin} \bigg( 4\Big(\theta\left(e_i\right) - \theta\left(e_j\right)\Big) - \frac{\pi}{2}\bigg) + 1
\end{split}
\end{equation}
Where $\theta\left(e_k\right) = \mathrm{atan2}\Big(\mathrm{y}\left(v_k^2\right) - \mathrm{y}\left(v_k^1\right), \mathrm{x}\left(v_k^2\right) - \mathrm{x}\left(v_k^1\right)\Big)$ is the angle formed by half-edge $k$ with the positive \emph{x-axis} direction, when treated as a vector based at $v_k^1$ and heading $v_k^2$, for $k \in \left\{i,j\right\}$. Therefore, the expression $\theta\left(e^i\right) - \theta\left(e^j\right)$ yields the signed angle between the two half-edges. Figure \ref{fig:angle_penalty} shows a plot of the angle penalty function for a range of $\theta$ values. It is easy to see that the angle penalty is minimized when the angle discrepancy between the two half-edges is an integer multiple of $\frac{\pi}{2}$, as required by the seamless condition. Please note, equation \ref{eq:angle_penalty} yields only non-negative values due to the introduction of the $+1$ term.
\begin{figure}[ht]
\centering
\includegraphics[width=15cm]{figures/seamless/angle_penalty_function.png}
\caption[The Angle Penalty Function]{A plot of the angle penalty function for a range of $\theta$ values. The penalty is zero for values of integer multiples of $\frac{\pi}{2}$, which represent a $\frac{\pi}{2}k$ rotation between the two half-edges, for $k \in \mathbb{N}$.}
\label{fig:angle_penalty}
\end{figure}
\paragraph{Length Penalty}
We define the length penalty function $P_{length}$ as follows:
\begin{equation}\label{length_penalty}
\begin{split}
P_{length}\left(e_i,e_j\right) = \left(\norm{e_i}_2^2 - \norm{e_j}_2^2\right)^2
\end{split}
\end{equation}
The length penalty measures the Euclidean length discrepancy between the two half-edges. It is a non-convex function (However, its Hessian is positive semi-definite almost everywhere) with multiple global minimum points associated with the function value of $0$. Therefore, It is easy to see that the length penalty is minimized when the length discrepancy between the two half-edges is absolutely zero, as required by the seamless condition. Figure \ref{fig:length_penalty} shows a plots of the length penalty function for a range of $\norm{e_i}_2^2$ and $\norm{e_j}_2^2$ values.
\begin{figure}[ht]
\centering
\includegraphics[width=12cm]{figures/seamless/length_penalty_function.png}
\caption[The Length Penalty Function]{A plot of the length penalty function. The penalty is zero along the $x=y$ line on the domain, where the lengths of the two half-edges are equal.}
\label{fig:length_penalty}
\end{figure}
% The length penalty measures the Euclidean length discrepancy between the two half-edges. It is a convex function (its Hessian is positive semi-definite) with multiple global minimum points associated with the function value of $0$. Therefore, It is easy to see that the length penalty is minimized when the length discrepancy between the two half-edges is absolutely zero, as required by the seamless condition.
\paragraph{Translation Penalty}
We define the translation penalty function $P_{translation}$ as follows:
\begin{equation}\label{eq:translation_penalty}
\begin{split}
P_{translation}\left(e_i,e_j\right) = \mathrm{sin} \Big( 2\pi\cdot\Delta_x\big(e_i,e_j\big) - \frac{\pi}{2}\Big) + \mathrm{sin} \Big( 2\pi\cdot\Delta_y\big(e_i,e_j\big) - \frac{\pi}{2}\Big) + 2
\end{split}
\end{equation}
Where $\Delta_x\big(e_i,e_j\big) = \mathrm{x}\left(v_i^1\right) - \mathrm{x}\left(v_j^1\right)$ and $\Delta_y\big(e_i,e_j\big) = \mathrm{y}\left(v_i^1\right) - \mathrm{y}\left(v_j^1\right)$ represent the Manhattan distance between the two twin-vertices $v^i_1$ and $v^j_1$, which is also, implicitly, the Manhattan distance between the two half-edges. Since the two sine terms in equation \ref{eq:translation_penalty} achieve their minimum value only for integer $\Delta_x$ and $\Delta_y$, it means that the function penalize non-integer Manhattan distances. Therefore, it is easy to see that the translation penalty is minimized when the two twin-vertices are integer distance apart, as required by the seamless condition. Figure \ref{fig:translation_penalty} shows a plot of the translation penalty function for a range of $\Delta_x$ and $\Delta_y$ values. Please note, equation \ref{eq:translation_penalty} yields only non-negative values due to the introduction of the $+2$ term.
\begin{figure}[ht]
\centering
\includegraphics[width=15cm]{figures/seamless/translation_penalty_function.png}
\caption[The Translation Penalty Function]{A plot of the translation penalty function for a range of values on the domain given by $\left[-2:2, -2:2\right]$. As can be seen, global minimum points are located at integer locations, which represent integer translations.}
\label{fig:translation_penalty}
\end{figure}
\subsection{The Singular-Points Condition's Objective Function}
The singular-points penalty function is applied on groups of twin-vertices on the parametrization domain, with non-zero angular defect (as defined in subsection \ref{label:singular_points_cond}). Given a group $V$ of twin-vertices that correspond to a singular point, the singular-points penalty function applied on that group is defined as follows:
\begin{equation}\label{eq:singular_points_penalty}
\begin{split}
P_{singular}\left(V\right) = \sum_{u \in V} \bigg( \mathrm{sin} \Big( 2\pi\cdot\mathrm{x}\big(u\big) - \frac{\pi}{2}\Big) + \mathrm{sin} \Big( 2\pi\cdot\mathrm{y}\big(u\big) - \frac{\pi}{2}\Big) + 2 \bigg)
\end{split}
\end{equation}
Where $\mathrm{x}\big(u\big)$ and $\mathrm{y}\big(u\big)$ represent the domain coordinates of a twin-vertex in $V$. Since the two sine terms in equation \ref{eq:singular_points_penalty} achieve their minimum value only for integer $\mathrm{x}\big(u\big)$ and $\mathrm{y}\big(u\big)$, it means that it penalize non-integer locations of singular twin-vertices. Therefore, it is easy to see that the translation penalty is minimized when \textbf{all} twin-vertices in $V$ are located on integer locations, as required by the singular-points condition. Please note, equation \ref{eq:singular_points_penalty} yields only non-negative values due to the introduction of the $+1$ term for each sine term. Figure \ref{fig:singular_points_penalty_sine_term} shows a plot of a single sine term from the singular-points penalty function for a range of $\mathrm{x}$ (or $\mathrm{y}$) values. Figure \ref{fig:singular_points_penalty_minimum} illustrates an example where the penalty function converge to a local minimum, where all twin-vertices located at grid-point locations.
\begin{figure}[ht]
\centering
\includegraphics[width=16cm]{figures/singular_points/singular_points_penalty_function_sine_term.png}
\caption[The Singular-Points Penalty Function (Single Sine Term)]{A plot of a single sine term of the singular-points penalty function for a range of $\mathrm{x}$ (or $\mathrm{y}$). As can be seen, global minimum points are located at integer locations, which represent integer grid coordinates.}
\label{fig:singular_points_penalty_sine_term}
\end{figure}
\begin{figure}[ht]
\centering
\includegraphics[width=16cm]{figures/singular_points/singular_points_penalty_function_minimum.png}
\caption[Singular-Points Penalty Function Global Minimum Example]{An example where the singular-points penalty function converges to a local minimum, when applied to a single singular-point. The red point on the mesh's surface represents a singular point of valence 3 (with respect to the black isolines), composed of a 7-facets blue triangle-fan. The corresponding triangle-soup on the parametrization domain satisfies the requirement that all twin-vertices of the singular-point are located on integer grid points. The sum of angles, adjacent to the group of twin-vertices, has a non-zero angular defect of $\frac{\pi}{2}$.}
\label{fig:singular_points_penalty_minimum}
\end{figure}
\subsection{The Consistent Orientation and Quad Distortion Conditions' Objective Functions}
In this subsection, we denote by $J\left(f_i\right)$ the Jacobian of the linear part of the affine mapping of triangle $f_i$ on the parametrization domain. Inspired by \cite{Smith:2015} and \cite{Poranne:Autocuts:2017}, we express both the consistent-orientation condition and the requirement to minimize triangle distortion on the domain, by the following penalty function:
\begin{equation}\label{eq:orientation_and_distortion_penalty}
\begin{split}
P_{\mathrm{dirichlet}}\left(f_i\right) = P_{\mathrm{distortion}}\left(f_i\right) + P_{\mathrm{orientation}}\left(f_i\right)
\end{split}
\end{equation}
Where the left term is given by $P_{\mathrm{distortion}}\left(f_i\right) = \norm{J\left(f_i\right)}_F^2$ , the right term is given by $P_{\mathrm{orientation}}\left(f_i\right) = \norm{J\left(f_i\right)^{-1}}_F^2$, and $\norm{\cdot}_F^2$ is the squared Frobenius norm. It is known that for $A \in \mathbb{R}_{n \times n}$, the Frobenius norm of $A$ is a function of its singular values given by $\norm{A}_F^2 = \sqrt{\sum_{i=1}^{n} \sigma_i^2}$. Therefore, since $J\left(f_i\right) \in \mathbb{R}_{2 \times 2}$, we can rewrite $P_{\mathrm{dirichlet}}$ as follows:
\begin{equation}\label{eq:orientation_and_distortion_penalty_explicit}
\begin{split}
P_{\mathrm{dirichlet}}\left(f_i\right) = \sigma^2_1 + \sigma^2_2 + \sigma^{-2}_1 +\sigma^{-2}_2
\end{split}
\end{equation}
Where $\sigma_1$ and $\sigma_2$ are the two singular values of $J\left(f_i\right)$. Given that the mapping is initialized such that $\sigma_i > 0$, the dirichlet penalty function will prevent triangle flips since $\sigma^{-2}_i \xrightarrow[\sigma_i \to 0^+]{} \infty$, for $i \in \left\{1,2\right\}$. Moreover, the dirichlet penalty function is minimized when the Jacobian induce an isometric mapping, since its global minimum is achieved at $\sigma_1 = 1$ and $\sigma_2 = 1$. Figure \ref{fig:dirichlet_penalty_function} illustrate the dirichlet penalty function for a range of $\sigma_1$ and $\sigma_2$ values.
\begin{figure}[ht]
\centering
\includegraphics[width=16cm]{figures/dirichlet/symmetric_dirichlet_penalty_function.png}
\caption[The Symmetric Dirichlet Penalty Function]{On the left, a perspective view of the dirichlet penalty function is plotted. As can be seen, "walls" are formed along the positive $\sigma_1 = 0$ and $\sigma_2 = 0$ half-lines, infinitely penalizing an attempt to cross into an adjacent quadrant. On the right, a top view of the dirichlet penalty function is plotted, clearly showing that its global minimum is achieved at $\sigma_1 = 1$ and $\sigma_2 = 1$.}
\label{fig:dirichlet_penalty_function}
\end{figure}
\subsection{The Main Objective Function}